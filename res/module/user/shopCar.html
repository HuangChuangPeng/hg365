<!DOCTYPE html>
<html>
<head>
<title>购物车</title>
<% include ../include/res.html %>
</head>
<body>
	<div id="J_content" class="hg-content">
		<% include ../include/head.html %>
		<div id="J_body" class="hg-body hg-box-bt">
			<ul class="shopcar-store" id="J_shopcar">

			</ul>
			<div class="hg-box-foot shopcar-foot" id="">
				<div class="shopcar-foot-all">
					<span class="shopcar-store-check"></span>
					<span class="hg-text">全选</span>
				</div>
				<div class="shopcar-foot-info">
					<div class="hg-desc">
						<span class="shopcar-foot-label">商品总额:</span>
						<span id="J_shopar_proall" class="shopcar-foot-text">-</span>
					</div>
					<div class="hg-desc">
						<span class="shopcar-foot-label">关税:</span>
						<span id="J_shopar_taxall" class="shopcar-foot-text">-</span>
					</div>
					<div class="shopcar-foot-total fn-text-overflow ">
						<span class="hg-text shopcar-foot-label">总计:</span>
						<span class="hg-text-price shopcar-foot-text"  id="J_shopar_all">-</span>
					</div>
				</div>
				<span class="hg-btn hg-btn-red fn-right">结 算</span>
			</div>
		</div>
		<% include ../include/foot.html %>
	</div>
	<% include ../include/js.html %>
	<textarea class="fn-hide" id="T_shopcar">
		{{#each this}}
		<li data-storeid="{{storeId}}">
			<div class="hg-text shopcar-store-title">
				<span class="shopcar-store-check"></span>
				<span class="hg-iconfont hg-iconfont-store"></span>
				<span>{{storeName}}</span>
				<span class="hg-iconfont hg-iconfont-rarrow fn-right"></span>
			</div>
			<div class="shopcar-store-content">
				<div class="hg-text shopcar-store-type"><span class="hg-iconfont hg-iconfont-in"></span>一般商品</div>
				<ul class="shopcar-prolist">
					{{#each normal}}
					<li class="fn-clear">
						<span class="shopcar-store-check"></span>
						<img src="{{img}}">
						<div class="shopcar-prolist-info">
							<h4 class="hg-text">{{name}}</h4>
							<p class="hg-desc">
								{{spec}}
							</p>
							<p class="hg-text-price">￥{{divide100 price}}</p>
							<div class="hg-counter" data-proid="{{id}}" data-storeid="{{../storeId}}">
								<i class="reduce">-</i>
								<input type="tel" value="{{number}}">
								<i class="add">+</i>
							</div>
						</div>
					</li>
					{{/each}}
				</ul>
				<div class="hg-text shopcar-store-type"><span class="hg-iconfont hg-iconfont-sea"></span>跨境商品</div>
				<ul class="shopcar-prolist ">
					{{#each cross}}
					<li class="fn-clear">
						<span class="shopcar-store-check"></span>
						<img src="{{img}}">
						<div class="shopcar-prolist-info">
							<h4 class="hg-text">{{name}}</h4>
							<p class="hg-desc">
								{{spec}}
							</p>
							<div class="">
								<span class="hg-text-price">￥{{divide100 price}}</span>
								<span class="shopcar-prolist-tax">税率{{taxRate}}%</span>
							</div>
							<div class="hg-counter" data-proid="{{id}}" data-storeid="{{../storeId}}">
								<i class="reduce">-</i>
								<input type="tel" value="{{number}}">
								<i class="add">+</i>
							</div>
						</div>
					</li>
					{{/each}}
				</ul>
			</div>
			<div class="shopcar-total fn-clear">
				<div class="fn-left hg-text">已选择<span class="J_shopcar_num"></span>件商品</div>
				<dl class="fn-right">
					<dt>商品总额:</dt>
					<dd class="J_shopcar_prototal"></dd>
					<dt>跨境关税:</dt>
					<dd class="J_shopcar_taxtotal"></dd>
					<dt class="shopcar-total-label">店铺小计:</dt>
					<dd class="hg-text-price J_shopcar_total"></dd>
					<dt class="shopcar-total-desc">(不含运费)</dt>
				</dl>
			</div>
		</li>
		{{/each}}
	</textarea>
	<script type="text/javascript">
	$('#J_head_title').html('购物车');
	window.shopCarSC={};
	window.shopCarSC.data=null;
	$(function(){
		//获取购物车数据
		hg.data({
			url:cfg.get('shopCar')
		}).done(function(json){
			$('#J_shopcar').temp($('#T_shopcar'),json.beans);
			//构建购物车数据对象，所有操作都基于这个对象
			window.shopCarSC.data=new ShopcarData(json.beans);
			$('.hg-counter').each(function(){
				$(this).makeCounter({
					max:199,
					min:1,
					callback:function(i,ele){
						//计数器变更时会触发这个回调
						//i为变更后的值，ele为触发的元素(加号或减号)
						var p=$(ele);
						var storeId=p.data('storeid');
						var id=p.data('proid');
						//更新数据对象中的数量，会触发数据改变事件（DATA_CHANGE）
						window.shopCarSC.data.setNum(storeId,id,i);
					}
				});
			});
			window.shopCarSC.data.on(ShopcarData.DATA_CHANGE,function(e){
				updateStore(e.storeId);
				updateTotal();
			});

			for(var i=0;i<json.beans.length;i++){
				var o=json.beans[i];
				updateStore(o.storeId);
			}
			updateTotal();
		});

		function updateStore(storeId){
			var storeCount=window.shopCarSC.data.countStore(storeId);
			var o=$('#J_shopcar>li[data-storeid="'+storeId+'"]');
			var proTotal=storeCount.normalTotal+storeCount.crossTotal;
			o.find('.J_shopcar_prototal').html('￥'+proTotal/100);
			o.find('.J_shopcar_taxtotal').html('￥'+storeCount.taxTotal/100);
			o.find('.J_shopcar_total').html('￥'+(proTotal+storeCount.taxTotal)/100);
			o.find('.J_shopcar_num').html(storeCount.normalNum+storeCount.crossNum);
		}

		function updateTotal(){
			var all=window.shopCarSC.data.countAll();
			var proTotal=all.normalTotal+all.crossTotal;
			$('#J_shopar_proall').html('￥'+proTotal/100);
			$('#J_shopar_taxall').html('￥'+all.taxTotal/100);
			$('#J_shopar_all').html('￥'+(proTotal+all.taxTotal)/100);
		}
	});


	/*
	购物车数据对象，不涉及DOM操作以提升效率
	每一项的结构为：
	{
		id:"",//单品ID
		price:"",//价格，分
		tax:"",//税率
		number:"",//数量
		check:"",//是否选中
		storeId:"",//店铺id
		type:""//是否跨境商品
	}
	*/
	function ShopcarData(beans){
		ZEvent.call(this);
		this.NORMAL=0,
		this.CROSS=1;
		this.data=[];
		for(var i = 0;i<beans.length;i++){
			var o=beans[i];
			initPro(this.data,o.normal,o.storeId,this.NORMAL);
			initPro(this.data,o.cross,o.storeId,this.CROSS);
		}
		function initPro(data,source,storeId,type){
			for(var e = 0;e<source.length;e++){
				var o=source[e];
				data.push({
					id:o.id,
					price:o.price,
					number:o.number,
					tax:o.taxRate,
					check:true,
					storeId:storeId,
					type:type
				});
			}
		}
	}
	ShopcarData.DATA_CHANGE='data_change';
	hg.inheritPrototype(ShopcarData,ZEvent);
	ShopcarData.prototype.count=function(cond){
		var normalTotal=0;//普通商品总额
		var crossTotal=0;//跨境商品总额
		var taxTotal=0;//税费总额
		var normalNum=0;//普通商品件数
		var crossNum=0;//跨境商品件数
		for(var i=0;i<this.data.length;i++){
			var o=this.data[i];
			if((!cond||cond(o))&&o.check){
				if(o.type==this.CROSS){
					crossTotal+=o.price*o.number;
					taxTotal+=o.price*o.number*o.tax/100;
					crossNum+=parseInt(o.number);
				}else{
					normalTotal+=o.price*o.number;
					normalNum+=parseInt(o.number);
				}
			}
		}
		return {
			normalTotal:normalTotal,
			crossTotal:crossTotal,
			taxTotal:taxTotal,
			normalNum:normalNum,
			crossNum:crossNum
		};
	}
	ShopcarData.prototype.countStore=function(storeId){
		return this.count(function(o){
			return storeId==o.storeId;
		});
	}
	ShopcarData.prototype.countAll=function(storeId){
		return this.count();
	}
	ShopcarData.prototype.setNum=function(storeId,id,num){
		for(var i = 0;i<this.data.length;i++){
			var o=this.data[i];
			if(id==o.id){
				o.number=num;
				this.trigger({
					name:ShopcarData.DATA_CHANGE,
					storeId:storeId
				});
				return;
			}
		}
	};
	</script>
</body>
</html>
